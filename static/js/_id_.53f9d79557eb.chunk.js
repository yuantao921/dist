import{o as x,a9 as L,r as l,ar as F,j as r,aJ as a,k as f,bI as M,cI as G,cJ as H,cK as R,ah as S,T as N,aj as Q,cL as j,F as B,av as q,ai as z,ce as W,by as J,bz as K,a7 as O,bA as U,cM as V,cN as $,bh as _,b0 as I,cO as X,H as Z,af as P,q as A,v as D,as as ee,bV as re}from"./vendor.83d59a4358fc.chunk.js";import{w as te,x as ce,y as ne,M as E,m as T,v as oe,A as Y,z as ae,b as ie}from"./index.8aebe18ecbfa.js";import{c as se}from"./constate.es.35fffc22355a.chunk.js";import{O as u}from"./order.269a0794995b.chunk.js";import{a as y}from"./plan.a4c4be1cb76c.chunk.js";const de=({tradeNo:t})=>{var g;const{t:e}=x(),{enqueueSnackbar:i}=L(),[c,s]=l.useState(u.PENDING),[o,m]=l.useState(!1),d=te(t),h=ce(t,{skip:c!==u.PENDING&&c!==u.PAID||!d.isSuccess,pollingInterval:1e3}),b=ne(void 0,{skip:c!==u.PENDING||!d.isSuccess}),[v,n]=l.useState(0),p=l.useMemo(()=>{var k;return new Map((k=b.data)==null?void 0:k.map(w=>[w.id,w]))},[b.data]);return l.useEffect(()=>{v===0&&b.isSuccess&&n(b.data[0].id)},[b.isSuccess,v,b.data]),l.useEffect(()=>{var k;(k=d.data)!=null&&k.status&&s(d.data.status)},[(g=d.data)==null?void 0:g.status]),l.useEffect(()=>{h.data&&s(h.data)},[h.data]),l.useEffect(()=>{d.error&&i(e("notice::order-detail-error",{error:d.error.message}),{variant:"error"})},[d.error]),{tradeNo:t,status:c,detail:d,callback:h,paymentMethod:b,paymentMethodIndex:p,paymentMethodState:v,setPaymentMethodState:n,isSubmitting:o,setSubmitting:m}},[le,C]=se(de),ue=()=>{const{t}=x(),{detail:{data:e,isLoading:i}}=C(),c=l.useMemo(()=>{const o=F.unix((e==null?void 0:e.created_at)||0);switch(e==null?void 0:e.period){case y.MONTHLY:return o.add(1,"month");case y.QUARTERLY:return o.add(3,"month");case y.HALF_YEARLY:return o.add(6,"month");case y.YEARLY:return o.add(1,"year");case y.TWO_YEARLY:return o.add(2,"year");case y.THREE_YEARLY:return o.add(3,"year");default:return o}},[e==null?void 0:e.created_at,e==null?void 0:e.period]),s=l.useMemo(()=>[{label:t("order.checkout.product-info-card.product-name"),value:e==null?void 0:e.plan.name},{label:t("order.checkout.product-info-card.product-type"),value:t("order.checkout.product-info-card.product-period",{context:e==null?void 0:e.period})},{label:t("order.checkout.product-info-card.traffic"),value:t("order.checkout.product-info-card.traffic",{count:(e==null?void 0:e.plan.transfer_enable)||0,context:(e==null?void 0:e.plan.transfer_enable)===null?"unlimited":"limited"})},...(e==null?void 0:e.period)===y.ONETIME?[]:[{label:t("order.checkout.product-info-card.next-billing-date"),value:c.format("YYYY/MM/DD")}]],[e,t,c]);return r(E,{title:t("order.checkout.product-info-card.title"),children:r(a,{container:!0,spacing:1,children:s.map((o,m)=>r(a,{item:!0,xs:12,children:f(a,{container:!0,spacing:2,children:[r(a,{item:!0,xs:4,children:o.label}),r(a,{item:!0,xs:8,children:i?r(M,{variant:"text",width:"100%"}):o.value})]})},m))})})},he=T()((t,{status:e})=>({root:{padding:t.spacing(1)},icon:{fontSize:t.spacing(8),color:t.palette[e===u.FINISHED?"success":"warning"].main}})),me=()=>{const{t}=x(),{status:e}=C(),{classes:i}=he({status:e}),c=l.useMemo(()=>{switch(e){case u.FINISHED:return r(R,{className:i.icon});case u.CANCELLED:return r(H,{className:i.icon});case u.PENDING:return r(G,{className:i.icon});default:return null}},[e]),s=l.useMemo(()=>{switch(e){case u.FINISHED:return"finished";case u.CANCELLED:return"cancelled";case u.PAID:return"paid";default:return null}},[e]);return r(E,{className:i.root,children:f(S,{direction:"column",spacing:3,children:[c,f(S,{direction:"column",spacing:1,alignItems:"center",children:[r(N,{variant:"h3",children:t("order.checkout.status-card.status",{context:s})}),r(N,{variant:"body1",color:"textSecondary",align:"center",children:t("order.checkout.status-card.description",{context:s})})]})]})})},pe=()=>{const{t}=x(),[e,{setLeft:i,setRight:c}]=Q(!1),{tradeNo:s}=C(),[o]=oe(),{enqueueSnackbar:m}=L(),d=j(async()=>{try{const h=await o(s).unwrap();h?(m(t("notice::order-cancel_success"),{variant:"success"}),I.event("order_cancel",{category:"order",label:"cancel",tradeNo:s,success:!0})):(m(t("notice::order-cancel_failed"),{variant:"error"}),I.event("order_cancel",{category:"order",label:"cancel",tradeNo:s,success:!1,error:h}))}catch(h){console.error("error when cancel order:",h),m(t("notice::order-cancel_failed"),{variant:"error"}),I.event("order_cancel",{category:"order",label:"cancel",tradeNo:s,success:!1,error:h})}i()});return f(B,{children:[r(q,{title:t("order.checkout.order-info-card.cancel-tooltip"),placement:"top",children:r(z,{onClick:c,children:r(W,{})})}),f(J,{open:e,onClose:i,children:[r(K,{children:r(S,{direction:"row",alignItems:"center",spacing:1.5,children:r(N,{variant:"inherit",children:t("order.checkout.order-info-card.cancel-dialog.title")})})}),r(O,{}),r(U,{children:r(V,{children:t("order.checkout.order-info-card.cancel-dialog.content")})}),f($,{children:[r(_,{onClick:i,children:t("order.checkout.order-info-card.cancel-dialog.cancel-button")}),r(_,{variant:"contained",color:"primary",onClick:d,children:t("order.checkout.order-info-card.cancel-dialog.confirm-button")})]})]})]})},fe=()=>{const{t}=x(),{detail:{data:e,isLoading:i},status:c}=C(),s=l.useMemo(()=>{switch(c){case u.FINISHED:return"paid";case u.CANCELLED:return"cancelled";case u.PENDING:return"pending";default:return null}},[c]),o=l.useMemo(()=>[{label:t("order.checkout.order-info-card.order-number"),value:e==null?void 0:e.trade_no},{label:t("order.checkout.order-info-card.order-date"),value:F.unix((e==null?void 0:e.created_at)||0).format("YYYY-MM-DD HH:mm:ss")},{label:t("order.checkout.order-info-card.order-status"),value:t("order.checkout.order-info-card.order-status-value",{context:s})},...e!=null&&e.discount_amount?[{label:t("order.checkout.order-info-card.coupon-amount"),value:t("order.checkout.order-info-card.price",{value:(Number((e==null?void 0:e.discount_amount)||0)/100).toFixed(2)})}]:[],...e!=null&&e.surplus_amount?[{label:t("order.checkout.order-info-card.subscription-deduct-amount"),value:t("order.checkout.order-info-card.price",{value:(Number((e==null?void 0:e.surplus_amount)||0)/100).toFixed(2)})}]:[],{label:t("order.checkout.order-info-card.order-amount"),value:t("order.checkout.order-info-card.price",{value:(Number((e==null?void 0:e.total_amount)||0)/100).toFixed(2)})}],[e,t]);return r(E,{title:t("order.checkout.order-info-card.title"),secondary:c===u.PENDING&&r(pe,{}),children:r(a,{container:!0,spacing:2,children:o.map((m,d)=>r(a,{item:!0,xs:12,children:f(a,{container:!0,spacing:2,children:[r(a,{item:!0,xs:4,children:m.label}),r(a,{item:!0,xs:8,children:r(N,{variant:"body1",noWrap:!0,children:i?r(M,{variant:"text",width:"100%"}):m.value})})]})},d))})})},be=T()(t=>({icon:{fontSize:t.spacing(2.5)}})),ge=()=>{const{t}=x(),{paymentMethod:{isLoading:e},detail:{isLoading:i},paymentMethodIndex:c,paymentMethodState:s,setPaymentMethodState:o,isSubmitting:m}=C(),d=l.useMemo(()=>Array.from(c.values()),[c]),{classes:h}=be(),b=l.useCallback(({icon:n})=>{switch(!0){case n.includes("alipay"):return r(Y,{type:"combined",children:r(X,{className:h.icon})});default:return r(Y,{type:"combined",color:"secondary",src:n})}},[]),v=n=>p=>{var g;p.preventDefault(),o(n.id),I.event("select",{category:"order",label:"payment_method",method:(g=c.get(n.id))==null?void 0:g.name,method_id:n.id})};return r(E,{title:t("order.checkout.payment-method-card.title"),content:!1,children:r(Z,{sx:{p:0},children:e||i?Array.from(new Array(3)).map((n,p)=>r(P,{disablePadding:!0,divider:!0,children:r(A,{disabled:!0,children:r(D,{children:r(M,{variant:"text",width:100})})})},p)):d.map(n=>r(P,{disablePadding:!0,divider:!0,children:f(A,{selected:s===n.id,disabled:m,onClick:v(n),onTouchEnd:v(n),children:[n.icon&&r(ee,{children:r(b,{icon:n.icon})}),r(D,{children:n.name})]})},n.id))})})},ke=()=>{const{t}=x(),{detail:{data:e,isLoading:i},paymentMethodState:c,paymentMethodIndex:s,setSubmitting:o,isSubmitting:m}=C(),[d]=ae(),{enqueueSnackbar:h}=L(),b=l.useMemo(()=>{var n,p,g,k;return[{label:e==null?void 0:e.plan.name,value:t("order.checkout.billing-card.price",{value:Number(((n=e==null?void 0:e.plan[e==null?void 0:e.period])!=null?n:0)/100).toFixed(2)})},...e!=null&&e.discount_amount||e!=null&&e.surplus_amount?[{label:t("order.checkout.billing-card.deduction"),value:t("order.checkout.billing-card.price",{value:((((p=e==null?void 0:e.discount_amount)!=null?p:0)+((g=e==null?void 0:e.surplus_amount)!=null?g:0))/-100).toFixed(2)})}]:[],{label:t("order.checkout.billing-card.total-price"),value:t("order.checkout.billing-card.price",{value:Number(((k=e==null?void 0:e.total_amount)!=null?k:0)/100).toFixed(2)})}]},[e,t]),v=l.useCallback(async n=>{var p,g;if(n.preventDefault(),e&&c)try{o(!0),I.event("click",{category:"order",label:"checkout",method:(p=s.get(c))==null?void 0:p.name,method_id:c}),window.location.href=await d({trade_no:e.trade_no,method:c}).unwrap()}catch(k){console.error(k),h(t("notice::checkout-failed"),{variant:"error"}),I.event("click",{category:"order",label:"checkout",method:(g=s.get(c))==null?void 0:g.name,method_id:c,success:!1,error:k})}finally{o(!1)}else h(t("notice::data-not-loaded"),{variant:"error"})},[d,e,c]);return r(E,{title:t("order.checkout.billing-card.title"),children:f(S,{spacing:2,divider:r(O,{}),children:[b.map((n,p)=>i?r(M,{variant:"text",width:"100%",height:40},p):f(S,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[r(N,{variant:"body1",children:n.label}),r(N,{variant:"body1",children:n.value})]},p)),r(_,{fullWidth:!0,variant:"contained",disabled:i||m,onClick:v,children:t("order.checkout.billing-card.button")})]})})},ve=()=>{const{status:t}=C();return f(a,{container:!0,spacing:2,children:[r(a,{item:!0,xs:!0,children:f(a,{container:!0,spacing:2,children:[t!==u.PENDING&&r(a,{item:!0,xs:12,children:r(me,{})}),r(a,{item:!0,xs:12,children:r(ue,{})}),r(a,{item:!0,xs:12,children:r(fe,{})}),t===u.PENDING&&r(a,{item:!0,xs:12})]})}),t===u.PENDING&&r(a,{item:!0,xs:12,md:4,children:f(a,{container:!0,spacing:2,children:[r(a,{item:!0,xs:12,children:r(ge,{})}),r(a,{item:!0,xs:12,children:r(ke,{})})]})})]})},Se=()=>{ie("checkout");const t=re().id;return r(le,{tradeNo:t||"",children:r(ve,{})})};export{Se as default};
